<ion-header>
  <ion-toolbar>
    <ion-buttons slot="end">
      <ion-button (click)="regresar()">
        <ion-icon name="arrow-back"></ion-icon>
        Regresar
      </ion-button>
    </ion-buttons>
    <ion-title>Administración de Usuarios</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content>

  <ion-segment [(ngModel)]="activeTab" color="primary">
    <ion-segment-button value="list">
      <ion-icon name="list-outline"></ion-icon>
      <ion-label>Usuarios</ion-label>
    </ion-segment-button>
    <ion-segment-button value="add">
      <ion-icon name="person-add-outline"></ion-icon>
      <ion-label>Agregar</ion-label>
    </ion-segment-button>
    <ion-segment-button value="edit">
      <ion-icon name="create-outline"></ion-icon>
      <ion-label>Editar</ion-label>
    </ion-segment-button>
  </ion-segment>

  <!-- Tab 1: Lista de Usuarios con Dropdown -->
  <div *ngIf="activeTab === 'list'">
    <ion-card>
      <ion-card-header>
        <ion-card-title>Lista de Usuarios</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-list>
          <ng-container *ngFor="let user of users">
            <ion-item button (click)="toggleUserDetails(user)">
              <ion-label>
                <h2>{{ user.username }}</h2>
                <p>{{ user.email }}</p>
              </ion-label>
              <ion-icon name="chevron-down-outline" *ngIf="!user.showDetails"></ion-icon>
              <ion-icon name="chevron-up-outline" *ngIf="user.showDetails"></ion-icon>
            </ion-item>
            <div *ngIf="user.showDetails" class="user-details">
              <ion-item>
                <ion-label><strong>Rol:</strong> {{ user.role || 'No disponible' }}</ion-label>
              </ion-item>
              <ion-item>
                <ion-label><strong>Última sesión:</strong> {{ user.last_login || 'No disponible' }}</ion-label>
              </ion-item>
            </div>
          </ng-container>
        </ion-list>
      </ion-card-content>
    </ion-card>
  </div>


  <!-- Tab 2: Agregar Usuario -->
  <div *ngIf="activeTab === 'add'">
    <ion-card>
      <ion-card-header>
        <ion-card-title>Agregar Nuevo Usuario</ion-card-title>
      </ion-card-header>
      <ion-card-content>

        <form [formGroup]="registroForm" (ngSubmit)="addUser()">
          <!-- Email -->
          <ion-item class="custom-item">
            <ion-icon name="mail-outline" slot="start"></ion-icon>
            <ion-label position="floating">Email</ion-label>
            <ion-input type="email" formControlName="email"></ion-input>
          </ion-item>
          <p *ngIf="registroForm.controls['email'].invalid && registroForm.controls['email'].touched"
            class="error-message">
            <ion-icon name="alert-circle-outline"></ion-icon> Ingrese un correo válido.
          </p>

          <!-- Nombre Completo -->
          <ion-item class="custom-item">
            <ion-icon name="person-outline" slot="start"></ion-icon>
            <ion-label position="floating">Full Name</ion-label>
            <ion-input type="text" formControlName="fullname" (ionInput)="convertToUppercase()"></ion-input>
          </ion-item>

          <!-- Username -->
          <ion-item class="custom-item">
            <ion-icon name="person-circle-outline" slot="start"></ion-icon>
            <ion-label position="floating">Username</ion-label>
            <ion-input type="text" formControlName="username"></ion-input>
          </ion-item>
          <p *ngIf="registroForm.controls['username'].invalid && registroForm.controls['username'].touched"
            class="error-message">
            <ion-icon name="alert-circle-outline"></ion-icon> No puede contener espacios.
          </p>

          <!-- Password -->
          <ion-item class="custom-item">
            <ion-icon name="lock-closed-outline" slot="start"></ion-icon>
            <ion-label position="floating">Password</ion-label>
            <ion-input [type]="showPassword ? 'text' : 'password'" formControlName="password"></ion-input>
            <ion-icon name="{{ showPassword ? 'eye-off' : 'eye' }}" slot="end"
              (click)="togglePasswordVisibility()"></ion-icon>
          </ion-item>

          <!-- Confirm Password -->
          <ion-item class="custom-item">
            <ion-icon name="lock-open-outline" slot="start"></ion-icon>
            <ion-label position="floating">Confirm Password</ion-label>
            <ion-input [type]="showPassword ? 'text' : 'password'" formControlName="confirmPassword"></ion-input>
          </ion-item>
          <p *ngIf="passwordsDoNotMatch" class="error-message">
            <ion-icon name="alert-circle-outline"></ion-icon> Las contraseñas no coinciden.
          </p>

          <!-- Birth Date -->
          <ion-item class="custom-item">
            <ion-icon name="calendar-outline" slot="start"></ion-icon>
            <ion-label position="floating">Birth Date</ion-label>
            <ion-input type="date" formControlName="birthDate"></ion-input>
          </ion-item>

          <ion-button expand="full" type="submit" [disabled]="registroForm.invalid">Agregar</ion-button>
        </form>

      </ion-card-content>
    </ion-card>
  </div>


  <!-- Tab 3: Modificar Usuario -->
  <div *ngIf="activeTab === 'edit'">
    <ion-card>
      <ion-card-header>
        <ion-card-title>Modificar Usuario</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-item>
          <ion-label position="floating">Seleccionar Usuario</ion-label>
          <ion-select [(ngModel)]="selectedUser">
            <ion-select-option *ngFor="let user of users" [value]="user">
              {{ user.username }} ({{ user.email }})
            </ion-select-option>
          </ion-select>
        </ion-item>

        <div *ngIf="selectedUser">
          <ion-item>
            <ion-label position="floating">Nuevo Nombre de Usuario</ion-label>
            <ion-input [(ngModel)]="selectedUser.username" type="text"></ion-input>
          </ion-item>

          <ion-item>
            <ion-label position="floating">Nuevo Email</ion-label>
            <ion-input [(ngModel)]="selectedUser.email" type="email"></ion-input>
          </ion-item>

          <ion-button expand="full" (click)="updateUser()">Guardar Cambios</ion-button>
        </div>
      </ion-card-content>
    </ion-card>
  </div>
</ion-content>